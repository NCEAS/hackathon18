---
title: "NCEAS Hackathon Participants Expenses"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

You will need to install the `googlesheets` and authorize your Google account to allow `R` to access your data. 


Read in data:

```{r libraries}
library(googlesheets) # install.packages('googlesheets')
library(tidyverse)
library(skimr)

```

This only works if the data is in a google drive, not team drive. What you need to do to make this work: 

Copy the two data sheets into your NCEAS google drive (not team drive). Then the following will work: 

```{r read in data}
## authorize googledocs -- requires user interaction with default browser
gs_auth(new_user = TRUE) 


#### read in Google Sheets ----
gus <-  googlesheets::gs_title("nceas-participants-expenses1718_oid") %>% 
  googlesheets::gs_read()   
head(gus)

admin <-  googlesheets::gs_title("nceas-participants_oid") %>%
  googlesheets::gs_read()   
head(admin)

```


## Wrangle

### Explore GUS: 
```{r}
g <- gus %>%
  select(person_oid = Vendor, 
         expense = Expense, # assume expense is food
         project_code = `Project Code`, 
         type = Type, 
         description = Description) %>%
  mutate(vendor = person_oid,
         person_oid = as.numeric(person_oid)) %>% # turn to numeric to remove non-numeric vendors
  filter(description != "provide research services") # others to filter?
str(g) #nrows = 1058

## Pattern 1: "2018 LTER Science Council Mtg, May 15-18, 2018" 
pattern1 <-  regex("[a-zA-Z]+ [0-9]+-[0-9]+, \\d{4}")  
str_match(g$description[1:5], pattern1)
str_view(g$description[1:15], pattern1)
                        
g <- g %>%
  mutate(date_extract = str_extract(description, pattern1)) %>%
  filter(is.na(date_extract))
str(g) #nrows = 730

## Pattern 2: "Amos, J.; SNAPP: Horizon Scanning Meeting, 7/15-19/18" or "LTER, Sokol: Mettacommunities, 5/14-17/18 and LTER, Hallett:"
pattern2 <- regex("[0-9]+/[0-9]+-[0-9]+/[0-9]+") 
str_match(g$description, pattern2)
str_view(g$description, pattern2)

g <- g %>%
  mutate(date_extract = str_extract(description, pattern2)) %>%
  filter(is.na(date_extract))
str(g) #nrow 624

## Pattern 3: "AF Palkovacs WG: 7/24-30,2017"
pattern3 <- regex("[0-9]+/[0-9]+-[0-9]+,\\d{4}") 
str_match(g$description, pattern3)
str_view(g$description, pattern3)

g <- g %>%
  mutate(date_extract = str_extract(description, pattern3)) %>%
  filter(is.na(date_extract))
str(g) #nrow 449


## Pattern 4: "Hyman WG: 08/01-2,17"
pattern4 <- regex("[0-9]+/[0-9]+-[0-9]+,\\d{2}") 
str_match(g$description, pattern4)
str_view(g$description, pattern4)

g <- g %>%
  mutate(date_extract = str_extract(description, pattern4)) %>%
  filter(is.na(date_extract))
str(g) #nrow 424

## Pattern 5: "CC: Gillquist Persona 7/11/2017"
pattern5 <- regex("[0-9]+/[0-9]+/\\d{4}") 
str_match(g$description, pattern5)
str_view(g$description, pattern5)

g <- g %>%
  mutate(date_extract = str_extract(description, pattern5)) %>%
  filter(is.na(date_extract))
str(g) #nrow 413

## Pattern 6: "AF SNAPP SAC and Mgmt: 7/18/17"
pattern6 <- regex("[0-9]+/[0-9]+/\\d{2}") 
str_match(g$description, pattern6)
str_view(g$description, pattern6)

g <- g %>%
  mutate(date_extract = str_extract(description, pattern6)) %>%
  filter(is.na(date_extract))
str(g) #nrow 396


unique(g$description)

## TODO (see notes below)
# string parse the dates from the description
# mutate(days_spent_in_SB)

# description field appears to be truncated, character limit of 60
# in GUS can type more than 60 but won't save all

unique(g$person_oid)



# filter out 7S
# fitler out

```


**Notes:**

Every time the vendor is a person_id and not a hotel name, we assume it's food. It could also be taxi, baggage fees. We assume that it's money paid in SB. 
 
It would be nice if there were a way to identify it more in GUS. 

Could also make the assumption that they spend $55 per day max. Then that way you could assume that was food (so could subtract from the total (`mutate(days_spent_in_SB)`). We don't know how much they spend over the 55/day.
 
### Explore Admin

```{r}

a <- admin %>%
  select(project_oid, lead_last, lead_first, start_date, end_date, activity_oid, person_oid, actv_type, is_onsite) %>%
  filter(actv_type %in% c("Working Group",
                          "Training Workshop",
                          "Workshop",
                          "Meeting",
                          "Advisory Board"))


   unique(a$actv_type)


# explore Other         
#a %>% filter(actv_type == "Other") %>% data.frame        

## TODO
# filter out the ones where is_onsite == FALSE

```
 
Fun fact: actv_type "Other" on 2/6 is the murder mystery party.
 
 
### Join
```{r}
admin_gus_full <- full_join(a, g, 
                  by = "person_oid")

admin_gus_onsite <- admin_gus_full %>%
  filter(is_onsite == TRUE) 


unique(admin_gus$type)

```

This person was in 2 activities, but none on-site. 

  project_oid lead_last lead_first start_date end_date activity_oid person_oid actv_type expense project_code type  descripti… vendor
1          NA NA        NA         NA         NA                 NA      51429 NA          1987. SASP4        PAR   Jones, M.… 51429 

Michael Jones: he was an offsite particpant 

We want
working_group, meeting, date, person, expenses

## Plots

How much money was spent on local restaurants over the past year by working group?





### Map

Where are visitors coming from?




